name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  goreleaser:
    name: Build and upload release assets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/tags/${{ github.event.release.tag_name }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Verify checkout tag
        run: |
          EXPECTED_TAG='${{ github.event.release.tag_name }}'
          ACTUAL_TAG=$(git describe --tags --exact-match 2>/dev/null || true)
          if [ "$ACTUAL_TAG" != "$EXPECTED_TAG" ]; then
            echo "::error::Checked-out ref mismatch. expected=$EXPECTED_TAG actual=${ACTUAL_TAG:-<empty>}"
            exit 1
          fi

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: goreleaser
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Extract version
        id: version
        run: |
          TAG_NAME='${{ github.event.release.tag_name }}'
          if [ -z "$TAG_NAME" ]; then
            echo "::error::Missing release tag name from github.event.release.tag_name"
            exit 1
          fi

          VERSION=${TAG_NAME#v}
          if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid release tag: $TAG_NAME"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          CLASS_SUFFIX=$(echo "$VERSION" | tr -d '.')
          echo "class_suffix=$CLASS_SUFFIX" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG_NAME"
          echo "Updating Homebrew Formula to version: $VERSION"

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: XiaoLFeng/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Ensure main formula exists
        working-directory: homebrew-tap
        run: |
          FORMULA_DIR="Formula/b"
          FORMULA_FILE="${FORMULA_DIR}/bamboo-base-cli.rb"
          mkdir -p "$FORMULA_DIR"

          if [ ! -f "$FORMULA_FILE" ]; then
            if curl -fsSL "https://raw.githubusercontent.com/XiaoLFeng/homebrew-tap/master/Formula/b/bamboo-base-cli.rb" -o "$FORMULA_FILE"; then
              echo "Initialized from remote Formula/b/bamboo-base-cli.rb (master)"
            elif curl -fsSL "https://raw.githubusercontent.com/XiaoLFeng/homebrew-tap/main/Formula/b/bamboo-base-cli.rb" -o "$FORMULA_FILE"; then
              echo "Initialized from remote Formula/b/bamboo-base-cli.rb (main)"
            elif curl -fsSL "https://raw.githubusercontent.com/XiaoLFeng/homebrew-tap/master/Formula/l/llm-memory.rb" -o "$FORMULA_FILE"; then
              echo "Initialized from remote fallback Formula/l/llm-memory.rb"
            else
              cat > "$FORMULA_FILE" <<'EOF'
              class BambooBaseCli < Formula
                desc "Bamboo Base Go CLI installer"
                homepage "https://github.com/bamboo-services/bamboo-base-go-cli"
                version "0.0.0"
                license "MIT"

                on_macos do
                  if Hardware::CPU.arm?
                    url "https://github.com/bamboo-services/bamboo-base-go-cli/releases/download/v#{version}/bamboo-base-cli-darwin-arm64"
                  else
                    url "https://github.com/bamboo-services/bamboo-base-go-cli/releases/download/v#{version}/bamboo-base-cli-darwin-amd64"
                  end
                end

                on_linux do
                  if Hardware::CPU.arm?
                    url "https://github.com/bamboo-services/bamboo-base-go-cli/releases/download/v#{version}/bamboo-base-cli-linux-arm64"
                  else
                    url "https://github.com/bamboo-services/bamboo-base-go-cli/releases/download/v#{version}/bamboo-base-cli-linux-amd64"
                  end
                end

                def install
                  if OS.mac?
                    if Hardware::CPU.arm?
                      bin.install "bamboo-base-cli-darwin-arm64" => "bamboo"
                    else
                      bin.install "bamboo-base-cli-darwin-amd64" => "bamboo"
                    end
                  elsif OS.linux?
                    if Hardware::CPU.arm?
                      bin.install "bamboo-base-cli-linux-arm64" => "bamboo"
                    else
                      bin.install "bamboo-base-cli-linux-amd64" => "bamboo"
                    end
                  end

                  chmod 0755, bin/"bamboo"
                end
              end
          EOF
            fi
          fi

          sed -i 's|https://github.com/XiaoLFeng/llm-memory|https://github.com/bamboo-services/bamboo-base-go-cli|g' "$FORMULA_FILE"
          sed -i 's/llm-memory/bamboo-base-cli/g' "$FORMULA_FILE"
          sed -i 's/class LlmMemory < Formula/class BambooBaseCli < Formula/' "$FORMULA_FILE"

      - name: Get old version
        id: old_version
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          FORMULA_FILE="Formula/b/bamboo-base-cli.rb"
          OLD_VERSION=""
          if [ -f "$FORMULA_FILE" ]; then
            OLD_VERSION=$(grep -oP 'version "\K[0-9]+\.[0-9]+\.[0-9]+' "$FORMULA_FILE" | head -n 1 || true)
          fi
          if [ -z "$OLD_VERSION" ]; then
            OLD_VERSION="$VERSION"
          fi
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          OLD_CLASS_SUFFIX=$(echo "$OLD_VERSION" | tr -d '.')
          echo "old_class_suffix=$OLD_CLASS_SUFFIX" >> $GITHUB_OUTPUT
          echo "Current version in Formula: $OLD_VERSION"

      - name: Create versioned Formula for old version
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
          OLD_VERSION: ${{ steps.old_version.outputs.old_version }}
          OLD_CLASS_SUFFIX: ${{ steps.old_version.outputs.old_class_suffix }}
        run: |
          VERSIONED_FILE="Formula/b/bamboo-base-cli@${OLD_VERSION}.rb"

          if [ "$OLD_VERSION" = "$VERSION" ]; then
            echo "Skip archive formula: old version equals current version ($VERSION)"
            exit 0
          fi

          if [ -f "$VERSIONED_FILE" ]; then
            echo "Versioned Formula already exists: $VERSIONED_FILE"
            exit 0
          fi

          cp Formula/b/bamboo-base-cli.rb "$VERSIONED_FILE"
          sed -i "s/class BambooBaseCli < Formula/class BambooBaseCliAT${OLD_CLASS_SUFFIX} < Formula/" "$VERSIONED_FILE"
          sed -i "s/bamboo-base-cli 已成功安装/bamboo-base-cli@${OLD_VERSION} 已成功安装/" "$VERSIONED_FILE"
          sed -i '/快速开始/i\      ⚠️  注意：这是一个固定版本的 Formula\n      - 此版本不会自动更新到更高版本\n      - 如需最新版本，请使用：brew install bamboo-base-cli\n' "$VERSIONED_FILE"

      - name: Update main Formula version
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          FORMULA_FILE="Formula/b/bamboo-base-cli.rb"

          sed -i 's|https://github.com/XiaoLFeng/llm-memory|https://github.com/bamboo-services/bamboo-base-go-cli|g' "$FORMULA_FILE"
          sed -i 's/llm-memory/bamboo-base-cli/g' "$FORMULA_FILE"
          sed -i 's/class LlmMemory < Formula/class BambooBaseCli < Formula/' "$FORMULA_FILE"
          sed -i 's/class BambooBaseCliAT[0-9]\+ < Formula/class BambooBaseCli < Formula/' "$FORMULA_FILE"

          if grep -qE '^[[:space:]]+version "[0-9]+\.[0-9]+\.[0-9]+"' "$FORMULA_FILE"; then
            sed -i -E 's/^[[:space:]]+version "[0-9]+\.[0-9]+\.[0-9]+"/  version "'"$VERSION"'"/' "$FORMULA_FILE"
          else
            sed -i '/^[[:space:]]*homepage ".*"/a\  version "'"$VERSION"'"' "$FORMULA_FILE"
          fi

          ACTUAL_VERSION=$(grep -oE 'version "[0-9]+\.[0-9]+\.[0-9]+"' "$FORMULA_FILE" | head -n 1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || true)
          if [ "$ACTUAL_VERSION" != "$VERSION" ]; then
            echo "::error::Version update verification failed. expected=$VERSION actual=${ACTUAL_VERSION:-<empty>}"
            exit 1
          fi

      - name: Commit and push changes
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
          OLD_VERSION: ${{ steps.old_version.outputs.old_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "No changes to commit (version might already be up to date)"
            exit 0
          fi

          git add Formula/b/

          if [ -f "Formula/b/bamboo-base-cli@${OLD_VERSION}.rb" ] && git diff --cached --name-only | grep -q "bamboo-base-cli@"; then
            git commit -m "chore(bamboo-base-cli): bump to v${VERSION}, archive v${OLD_VERSION}

          - Update bamboo-base-cli.rb to version ${VERSION}
          - Create bamboo-base-cli@${OLD_VERSION}.rb for version pinning

          Automated update from bamboo-base-go-cli release workflow.
          Release: https://github.com/bamboo-services/bamboo-base-go-cli/releases/tag/v${VERSION}"
          else
            git commit -m "chore(bamboo-base-cli): bump version to ${VERSION}

          Automated update from bamboo-base-go-cli release workflow.
          Release: https://github.com/bamboo-services/bamboo-base-go-cli/releases/tag/v${VERSION}"
          fi

          git push origin master
          echo "✅ Successfully updated homebrew-tap!"
